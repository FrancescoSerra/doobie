<!DOCTYPE html>
<html class="no-js" lang="en">

<head>
<title>Managing Connections · doobie</title>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content='docs'/>
<link href="https://fonts.googleapis.com/css?family=Roboto:100normal,100italic,300normal,300italic,400normal,400italic,500normal,500italic,700normal,700italic,900normal,900italicc" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../lib/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../js/page.js"></script>
<script type="text/javascript" src="../js/warnOldVersion.js"></script>
<script type="text/javascript" src="../js/groups.js"></script>
<script type="text/javascript" src="../js/snippets.js"></script>
<link rel="stylesheet" type="text/css" href="../lib/foundation/dist/foundation.min.css"/>
<link rel="stylesheet" type="text/css" href="../css/page.css"/>

<!--
<link rel="shortcut icon" href="../images/favicon.ico" />
-->
</head>

<body>
<div class="off-canvas-wrapper">
<div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>

<div class="off-canvas position-left" id="off-canvas-menu" data-off-canvas>
<nav class="off-canvas-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
0.12.1
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="active page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-Quill.html" class="page">Quill Integration</a></li>
    <li><a href="../docs/18-FAQ.html" class="page">Frequently-Asked Questions</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="off-canvas-content" data-off-canvas-content>

<header class="site-header expanded row">
<div class="small-12 column">
<a href="#" class="off-canvas-toggle hide-for-medium" data-toggle="off-canvas-menu"><svg class="svg-icon svg-icon-menu" version="1.1" id="Menu" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 20 20" enable-background="new 0 0 20 20" xml:space="preserve"> <path class="svg-icon-menu-path" fill="#53CDEC" d="M16.4,9H3.6C3.048,9,3,9.447,3,10c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,9.447,16.952,9,16.4,9z M16.4,13
H3.6C3.048,13,3,13.447,3,14c0,0.553,0.048,1,0.6,1H16.4c0.552,0,0.6-0.447,0.6-1C17,13.447,16.952,13,16.4,13z M3.6,7H16.4
C16.952,7,17,6.553,17,6c0-0.553-0.048-1-0.6-1H3.6C3.048,5,3,5.447,3,6C3,6.553,3.048,7,3.6,7z"/></svg>
</a>
<div class="title"><a href="../index.html">doobie</a></div>

<!--
<a href="https://www.example.com" class="logo show-for-medium">logo</a>
-->
</div>
</header>

<div class="expanded row">

<div class="medium-3 large-2 show-for-medium column">
<nav class="site-nav">
<div class="nav-home">
<a href="../index.html" >
<span class="home-icon">⌂</span>doobie
</a>
<div class="version-number">
0.12.1
</div>
</div>
<div class="nav-toc">
<ul>
  <li><a href="../infographic.html" class="page">Infographic</a></li>
  <li><a href="../migration.html" class="page">Migration Notes</a></li>
  <li><a href="../docs/index.html" class="page">Book of Doobie</a>
  <ul>
    <li><a href="../docs/01-Introduction.html" class="page">Introduction</a></li>
    <li><a href="../docs/02-Toolkit.html" class="page">Toolkit</a></li>
    <li><a href="../docs/03-Connecting.html" class="page">Connecting to a Database</a></li>
    <li><a href="../docs/04-Selecting.html" class="page">Selecting Data</a></li>
    <li><a href="../docs/05-Parameterized.html" class="page">Parameterized Queries</a></li>
    <li><a href="../docs/06-Checking.html" class="page">Typechecking Queries</a></li>
    <li><a href="../docs/07-Updating.html" class="page">DDL, Inserting, and Updating</a></li>
    <li><a href="../docs/08-Fragments.html" class="page">Statement Fragments</a></li>
    <li><a href="../docs/09-Error-Handling.html" class="page">Error Handling</a></li>
    <li><a href="../docs/10-Logging.html" class="page">Logging</a></li>
    <li><a href="../docs/11-Arrays.html" class="page">SQL Arrays</a></li>
    <li><a href="../docs/12-Custom-Mappings.html" class="page">Custom Mappings</a></li>
    <li><a href="../docs/13-Unit-Testing.html" class="page">Unit Testing</a></li>
    <li><a href="../docs/14-Managing-Connections.html" class="active page">Managing Connections</a></li>
    <li><a href="../docs/15-Extensions-PostgreSQL.html" class="page">Extensions for PostgreSQL</a></li>
    <li><a href="../docs/16-Extensions-H2.html" class="page">Extensions for H2</a></li>
    <li><a href="../docs/17-Quill.html" class="page">Quill Integration</a></li>
    <li><a href="../docs/18-FAQ.html" class="page">Frequently-Asked Questions</a></li>
  </ul></li>
</ul>
</div>

</nav>
</div>

<div class="small-12 medium-9 large-10 column">
<section class="site-content">

<span id="version-warning"></span>

<div class="page-header row">
<div class="medium-12 show-for-medium column">
<div class="nav-breadcrumbs">
<ul>
  <li><a href="../index.html">doobie</a></li>
  <li><a href="../docs/index.html">Book of Doobie</a></li>
  <li>Managing Connections</li>
</ul>
</div>
</div>
</div>

<div class="page-content row">
<div class="small-12 large-9 column" id="docs">
<h2><a href="#managing-connections" name="managing-connections" class="anchor"><span class="anchor-link"></span></a>Managing Connections</h2>
<p>In this chapter we discuss several ways to manage connections in applications that use <strong>doobie</strong>, including managed/pooled connections and re-use of existing connections. For this chapter we have a few imports and no other setup.</p>
<pre class="prettyprint"><code class="language-scala">import cats._
import cats.data._
import cats.effect._
import cats.implicits._
import doobie._
import doobie.implicits._
</code></pre>
<h3><a href="#about-transactors" name="about-transactors" class="anchor"><span class="anchor-link"></span></a>About Transactors</h3>
<p>Most <strong>doobie</strong> programs are values of type <code>ConnectionIO[A]</code> or <code>Stream[ConnnectionIO, A]</code> that describe computations requiring a database connection. By providing a means of acquiring a JDBC connection we can transform these programs into computations that can actually be executed. The most common way of performing this transformation is via a <code>Transactor</code>.</p>
<p>A <code>Transactor[M]</code> consists of the following bits of information:</p>
<ul>
  <li>An arbitrary piece of configuration, called the <code>kernel</code>, particular to a given implementation (see below);</li>
  <li>a source of connections, computed in <code>M</code> (typically <code>IO</code>);</li>
  <li>an <em>interpreter</em> from <code>ConnectionOp ~&gt; M</code>; and</li>
  <li>a transaction <code>Strategy</code> that specifies a setup, error-handling, and cleanup strategy associated with each database interation.</li>
</ul>
<p>Given this information a <code>Transactor[M]</code> can provide the following transformations:</p>
<ul>
  <li><code>trans: ConnectionIO ~&gt; M</code> A natural transformation of a program in <code>ConnectionIO</code> to the target monad <code>M</code> that uses the given <code>Strategy</code> to wrap the given program with additional setup, error-handling and cleanup operations. This yields an independent program in <code>M</code>. This is the most common way to run a doobie program.
    <ul>
      <li>e.g., <code>xa.trans.apply(program1)</code></li>
      <li>you can also use the syntax <code>program1.transact(xa)</code>, which runs <code>xa.trans</code> under the hood</li>
    </ul>
  </li>
  <li><code>rawTrans</code> natural transformation equivalent to <code>trans</code> but one that does not use the provided <code>Strategy</code> to wrap the given program with additional operations. This can be useful in cases where transactional handling is unsupported or undesired.</li>
  <li><code>rawTransP: Stream[ConnectionIO, ?] ~&gt; Stream[M, ?]</code> equivalent to <code>rawTrans</code> but expressed using <code>Stream</code>.</li>
  <li><code>transP: Stream[ConnectionIO, ?] ~&gt; Stream[M, ?]</code> equivalent to <code>trans</code> but expressed using <code>Stream</code>.</li>
  <li><code>exec: Kleisli[M, Connection, ?] ~&gt; M</code> equivalent to <code>trans</code> except it transforms a <code>Kleisli</code> that expects a <code>java.sql.Connection</code> and not a <code>ConnectionIO</code>. This can be used in combination with the doobie interpreters, which can transform doobie programs (e.g., <code>ConnectionIO</code>) to <code>Kleisli</code> effects, in order to implement your own logic for running doobie programs.</li>
  <li><code>rawExec</code> natural transformation equivalent to <code>exec</code> but one that does not use the provided <code>Strategy</code> to wrap the given program with additional operations.</li>
</ul>
<p>So summarizing, once you have a <code>Transactor[M]</code> you have a way of discharging <code>ConnectionIO</code> and replacing it with some effectful <code>M</code> like <code>IO</code>. In effect this turns a <strong>doobie</strong> program into a &ldquo;real&rdquo; program value that you can integrate with the rest of your application; all doobieness is left behind.</p>
<h3><a href="#about-threading" name="about-threading" class="anchor"><span class="anchor-link"></span></a>About Threading</h3>
<p>Starting with version 0.6.0 <strong>doobie</strong> provides an asynchronous API that delegates blocking operations to dedicated execution contexts <em>if you use the provided <code>Transactor</code> implementations</em>. To construct any of the provided <code>Transactor[M]</code>s (other than <code>DriverManagerTransactor</code>) you need</p>
<ul>
  <li><code>ContextShift[M]</code>, which provides a CPU-bound pool for <strong>non-blocking operations</strong>. If you use <code>IOApp</code> and interpret into <code>IO</code> the ContextShift will be backed by a fixed thread pool matching the numbers of your processors.</li>
  <li>An <code>ExecutionContext</code> for <strong>awaiting connection</strong> to the database. Because there can be an unbounded number of connections awaiting database access this should be a <strong>bounded</strong> pool.</li>
  <li>A <code>cats.effect.Blocker</code> for <strong>executing JDBC operations</strong>. Because your connection pool limits the number of active connections this should be an <strong>unbounded</strong> pool.</li>
</ul>
<p>The reason for having separate pools for awaiting connections and executing JDBC operations is liveness - we must avoid the situation where all the threads in the pool are blocked on acquiring a JDBC connection, meaning that no logical threads are able to make progress and release the connection they&rsquo;re currently holding.</p>
<p>Also note that the number of JDBC connections is usually limited by the underlying JDBC pool. You may therefore want to limit your connection pool to the same size as the underlying JDBC pool as any additional threads are guaranteed to be blocked.</p>
<p>Because these pools need to be shut down in order to exit cleanly it is typical to use <code>Resource</code> to manage their lifetimes. See below for examples.</p>
<h3><a href="#using-the-jdbc-drivermanager" name="using-the-jdbc-drivermanager" class="anchor"><span class="anchor-link"></span></a>Using the JDBC DriverManager</h3>
<p>JDBC provides a bare-bones connection provider via <code>DriverManager.getConnection</code>, which has the advantage of being extremely simple: there is no connection pooling and thus no configuration required. The disadvantage is that it is quite a bit slower than pooling connection managers, and provides no upper bound on the number of concurrent connections. It executes blocking operations on a similar unbounded pool of daemon threads.</p>
<p>However, for test and for experimentation as described in this book (and for situations where you really do want to ensure that you get a truly fresh connection right away) the <code>DriverManager</code> is fine. Support in <strong>doobie</strong> is via <code>DriverManagerTransactor</code>. To construct one you must pass the name of the driver class and a connect URL. Normally you will also pass a user/password (the API provides several variants matching the <code>DriverManager</code> static API).</p>
<pre class="prettyprint"><code class="language-scala">import doobie.util.ExecutionContexts

// We need a ContextShift[IO] before we can construct a Transactor[IO]. The passed ExecutionContext
// is where nonblocking operations will be executed. For testing here we&#39;re using a synchronous EC.
implicit val cs = IO.contextShift(ExecutionContexts.synchronous)

// A transactor that gets connections from java.sql.DriverManager and executes blocking operations
// on an our synchronous EC. See the chapter on connection handling for more info.
val xa = Transactor.fromDriverManager[IO](
  &quot;org.postgresql.Driver&quot;,     // driver classname
  &quot;jdbc:postgresql:world&quot;,     // connect URL (driver-specific)
  &quot;postgres&quot;,                  // user
  &quot;&quot;,                          // password
  Blocker.liftExecutionContext(ExecutionContexts.synchronous) // just for testing
)
</code></pre>
<h3><a href="#using-a-hikaricp-connection-pool" name="using-a-hikaricp-connection-pool" class="anchor"><span class="anchor-link"></span></a>Using a HikariCP Connection Pool</h3>
<p>The <code>doobie-hikari</code> add-on provides a <code>Transactor</code> implementation backed by a <a href="https://github.com/brettwooldridge/HikariCP">HikariCP</a> connection pool. The connection pool is a lifetime-managed object that must be shut down cleanly, so it is managed as a <code>Resource</code>. A program that uses <code>HikariTransactor</code> will typically use <code>IOApp</code>.</p>
<pre class="prettyprint"><code class="language-scala">import cats.effect._
import cats.implicits._
import doobie._
import doobie.implicits._
import doobie.hikari._

object HikariApp extends IOApp {

  // Resource yielding a transactor configured with a bounded connect EC and an unbounded
  // transaction EC. Everything will be closed and shut down cleanly after use.
  val transactor: Resource[IO, HikariTransactor[IO]] =
    for {
      ce &lt;- ExecutionContexts.fixedThreadPool[IO](32) // our connect EC
      be &lt;- Blocker[IO]    // our blocking EC
      xa &lt;- HikariTransactor.newHikariTransactor[IO](
              &quot;org.h2.Driver&quot;,                        // driver classname
              &quot;jdbc:h2:mem:test;DB_CLOSE_DELAY=-1&quot;,   // connect URL
              &quot;sa&quot;,                                   // username
              &quot;&quot;,                                     // password
              ce,                                     // await connection here
              be                                      // execute JDBC operations here
            )
    } yield xa


  def run(args: List[String]): IO[ExitCode] =
    transactor.use { xa =&gt;

      // Construct and run your server here!
      for {
        n &lt;- sql&quot;select 42&quot;.query[Int].unique.transact(xa)
        _ &lt;- IO(println(n))
      } yield ExitCode.Success

    }

}
</code></pre>
<p>And running this program gives us the desired result.</p>
<pre class="prettyprint"><code class="language-scala">HikariApp.main(Array())
// 42
</code></pre>
<h3><a href="#using-an-existing-datasource" name="using-an-existing-datasource" class="anchor"><span class="anchor-link"></span></a>Using an existing DataSource</h3>
<p>If your application exposes an existing <code>javax.sql.DataSource</code> you can use it directly by wrapping it in a <code>DataSourceTransactor</code>. You still need to provide execution contexts.</p>
<pre class="prettyprint"><code class="language-scala">import javax.sql.DataSource

// Resource yielding a DataSourceTransactor[IO] wrapping the given `DataSource`
def transactor(ds: DataSource)(
  implicit ev: ContextShift[IO]
): Resource[IO, DataSourceTransactor[IO]] =
  for {
    ce &lt;- ExecutionContexts.fixedThreadPool[IO](32) // our connect EC
    be &lt;- Blocker[IO]    // our blocking EC
  } yield Transactor.fromDataSource[IO](ds, ce, be)
</code></pre>
<p>The <code>configure</code> method on <code>DataSourceTransactor</code> provides access to the underlying <code>DataSource</code> if additional configuration is required.</p>
<h3><a href="#using-an-existing-jdbc-connection" name="using-an-existing-jdbc-connection" class="anchor"><span class="anchor-link"></span></a>Using an Existing JDBC Connection</h3>
<p>If your application exposes an existing <code>Connection</code> you can use it directly by wrapping it in a <code>Transactor</code>. You still need to provide an execution context for blocking operations. Note that you are responsible for closing the <code>Connection</code>.</p>
<pre class="prettyprint"><code class="language-scala">import java.sql.Connection

// Resource yielding a Transactor[IO] wrapping the given `Connection`
def transactor(c: Connection)(
  implicit ev: ContextShift[IO]
): Resource[IO, Transactor[IO]] =
  Blocker[IO].map { b =&gt;
    Transactor.fromConnection[IO](c, b)
  }
</code></pre>
<h3><a href="#customizing-transactors" name="customizing-transactors" class="anchor"><span class="anchor-link"></span></a>Customizing Transactors</h3>
<p>If the default <code>Transactor</code> behavior don&rsquo;t meet your needs you can replace any member with one that does what you need. See the Scaladoc for <code>Transactor</code> and <code>Strategy</code> for details on the structure. Lenses are provided to make it straightforward to replace just the piece you&rsquo;re interested in. For example, to create a transactor that is the same as <code>xa</code> but always rolls back (for testing perhaps) you can say:</p>
<pre class="prettyprint"><code class="language-scala">val testXa = Transactor.after.set(xa, HC.rollback)
</code></pre>
<p>As another example, Hive&rsquo;s JDBC driver doesn&rsquo;t support transaction commit or rollback, you can create your own <code>Transactor</code> to accommodate that, like:</p>
<pre class="prettyprint"><code class="language-scala">import doobie.free.connection.unit

val hiveXa = Transactor.strategy.set(xa, Strategy.default.copy(after = unit, oops = unit))
</code></pre>
<div class="source-github">
The source code for this page can be found <a href="https://github.com/tpolecat/doobie/tree/v0.12.1/modules/docs/target/mdoc/docs/14-Managing-Connections.md">here</a>.
</div>

<div class="nav-next">
<p><strong>Next:</strong> <a href="../docs/15-Extensions-PostgreSQL.html">Extensions for PostgreSQL</a></p>
</div>
</div>
<div class="large-3 show-for-large column" data-sticky-container>
<nav class="sidebar sticky" data-sticky data-anchor="docs" data-sticky-on="large">
<div class="page-nav">
<div class="nav-title">On this page:</div>
<div class="nav-toc">
<ul>
  <li><a href="../docs/14-Managing-Connections.html#managing-connections" class="header">Managing Connections</a>
  <ul>
    <li><a href="../docs/14-Managing-Connections.html#about-transactors" class="header">About Transactors</a></li>
    <li><a href="../docs/14-Managing-Connections.html#about-threading" class="header">About Threading</a></li>
    <li><a href="../docs/14-Managing-Connections.html#using-the-jdbc-drivermanager" class="header">Using the JDBC DriverManager</a></li>
    <li><a href="../docs/14-Managing-Connections.html#using-a-hikaricp-connection-pool" class="header">Using a HikariCP Connection Pool</a></li>
    <li><a href="../docs/14-Managing-Connections.html#using-an-existing-datasource" class="header">Using an existing DataSource</a></li>
    <li><a href="../docs/14-Managing-Connections.html#using-an-existing-jdbc-connection" class="header">Using an Existing JDBC Connection</a></li>
    <li><a href="../docs/14-Managing-Connections.html#customizing-transactors" class="header">Customizing Transactors</a></li>
  </ul></li>
</ul>
</div>
</div>
</nav>
</div>
</div>

</section>
</div>

</div>

<footer class="site-footer">

<section class="site-footer-nav">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 medium-4 large-3 text-center column">
<div class="nav-links">
<ul>
<!-- <li><a href="https://www.example.com/products/">Products</a> -->
</ul>
</div>
</div>

</div>
</div>
</div>
</section>

<section class="site-footer-base">
<div class="expanded row">
<div class="small-12 large-offset-2 large-10 column">
<div class="row site-footer-content">

<div class="small-12 text-center large-9 column">

<!--
<div class="copyright">
<span class="text">&copy; 2021</span>
<a href="https://www.example.com" class="logo">logo</a>
</div>
-->
</div>

</div>
</div>
</div>
</section>
</footer>

</div>
</div>
</div>
</body>

<script type="text/javascript" src="../lib/foundation/dist/foundation.min.js"></script>
<script type="text/javascript">jQuery(document).foundation();</script>
<script type="text/javascript" src="../js/magellan.js"></script>

<style type="text/css">@import "../lib/prettify/prettify.css";</style>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">jQuery(function(){window.prettyPrint && prettyPrint()});</script>
<script type="text/javascript">jQuery(function(jq){initOldVersionWarnings(jq, '0.12.1', '')});</script>


</html>
